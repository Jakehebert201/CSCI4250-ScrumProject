<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | Student Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body class="layout">
    <header class="page-header">
        <a class="brand" href="{{ url_for('main.landing_page') }}">Student Location Tracker</a>
        <nav class="page-nav">
            <a href="{{ url_for('main.student_dashboard') }}" class="nav__item nav__item--active">Dashboard</a>
            <a href="/app/classes/" class="nav__item">Classes</a>
            <a href="/app/notifications" class="nav__item">
                üîî Notifications
                <span class="notification-badge" id="nav-notification-badge" style="display: none;"></span>
            </a>
            <a href="{{ url_for('main.database') }}" class="nav__item">My Data</a>
            <a href="{{ url_for('auth.logout') }}" class="nav__item">Log Out</a>
        </nav>
    </header>
    <main class="dashboard">
        <section class="dashboard__panel">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                {% if student.profile_picture %}
                    <img src="{{ student.profile_picture }}" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--primary);">
                {% endif %}
                <div>
                    <h1 style="margin: 0;">Welcome back, {{ full_name }}!</h1>
                    {% if student.is_oauth_user %}
                        <span style="background: var(--accent); color: var(--text); padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">Google Account</span>
                    {% endif %}
                </div>
            </div>
            <p class="dashboard__subtitle">Your current location appears on the map below. Share updates with campus safety as needed.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                <div>
                    <strong>Student ID:</strong> {{ student.student_id or 'Not set' }}<br>
                    <strong>Major:</strong> {{ student.major or 'Not specified' }}<br>
                    <strong>Year:</strong> {{ student.year or 'Not specified' }}
                </div>
                <div>
                    <strong>Email:</strong> {{ student.email }}<br>
                    <strong>Member since:</strong> {{ student.created_at.strftime('%B %Y') }}<br>
                    <strong>Account type:</strong> {{ 'OAuth' if student.is_oauth_user else 'Traditional' }}
                </div>
            </div>

            <div class="dashboard__status">
                <div>
                    <span class="status__label">Latitude:</span>
                    <span id="latitude" class="status__value">--</span>
                </div>
                <div>
                    <span class="status__label">Longitude:</span>
                    <span id="longitude" class="status__value">--</span>
                </div>
                <div>
                    <span class="status__label">Accuracy:</span>
                    <span id="accuracy" class="status__value">--</span>
                </div>
                <div>
                    <span class="status__label">Last Updated:</span>
                    <span id="timestamp" class="status__value">Waiting...</span>
                </div>
            </div>
            <div id="location-map" class="dashboard__map" role="img" aria-label="Map showing your current location"></div>
            <p id="location-message" class="dashboard__message">Requesting location access...</p>
            
            <!-- Student's Location History Map -->
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; color: var(--primary);">üìç My Location History</h3>
                    <button id="clear-locations-btn" class="btn" style="background: #ef4444; color: white;">
                        üóëÔ∏è Clear My Locations
                    </button>
                </div>
                <div id="history-map" class="dashboard__map" role="img" aria-label="Map showing your location history"></div>
                <p class="dashboard__message">Your location check-ins and movement history.</p>
            </div>
            <section class="clock-section" aria-labelledby="clock-section-title">
                <h2 id="clock-section-title" class="clock-section__title">Clock In/Out</h2>
                <div class="clock-button-group">
                    <form id="clock-event-form" data-endpoint="{{ url_for('api.clock_event') }}" hidden>
                        <input type="hidden" name="event_type" id="clock-event-type">
                        <input type="hidden" name="timestamp" id="clock-event-timestamp">
                        <input type="hidden" name="lat" id="clock-event-lat">
                        <input type="hidden" name="lng" id="clock-event-lng">
                        <input type="hidden" name="accuracy" id="clock-event-accuracy">
                    </form>

                    <button id="clock-in" class="clock-button">
                        <span class="clock-button__title">Clock In</span>
                        <span class="clock-button__meta" aria-live="polite">
                            <span>Last: <time id="clock-in-last" datetime="">Never</time></span>
                            <span>Elapsed: <span id="clock-in-elapsed">--</span></span>
                        </span>
                    </button>
                    <button id="clock-out" class="clock-button">
                        <span class="clock-button__title">Clock Out</span>
                        <span class="clock-button__meta" aria-live="polite">
                            <span>Last: <time id="clock-out-last" datetime="">Never</time></span>
                            <span>Elapsed: <span id="clock-out-elapsed">--</span></span>
                        </span>
                    </button>
                </div>
            </section>
        </section>
    </main>
    <footer class="footer">
        <small>&copy; 2025 Student Tracker. Built with Flask.</small>
    </footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
    var lastKnownPosition = null;
    // If geolocation API is missing (common on insecure origins), show guidance
    if (!navigator.geolocation) {
      var msgEl = document.getElementById('location-message');
      if (msgEl) {
        if (window.location.protocol === 'http:') {
          msgEl.textContent = 'Location is blocked on insecure connections (HTTP). Please use HTTPS or run the app on localhost to enable geolocation.';
          var tryBtn = document.createElement('button');
          tryBtn.textContent = 'Try HTTPS';
          tryBtn.className = 'btn';
          tryBtn.style.marginLeft = '0.5rem';
          tryBtn.addEventListener('click', function() {
            window.location.href = window.location.href.replace('http://', 'https://');
          });
          msgEl.appendChild(document.createElement('br'));
          msgEl.appendChild(tryBtn);
        } else {
          msgEl.textContent = 'Geolocation is not available in your browser or permission was denied.';
        }
      }
    }
    // Send location to server for students
    function postLocation(lat, lng, accuracy) {
      lastKnownPosition = { lat: lat, lng: lng, accuracy: accuracy };
      fetch("{{ url_for('api.update_location') }}", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: lat, lng: lng, accuracy: accuracy })
      }).catch(err => console.debug("location post failed", err));
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        var acc = pos.coords.accuracy;
        
        var elLat = document.getElementById('latitude');
        var elLng = document.getElementById('longitude');
        var elAcc = document.getElementById('accuracy');
        if (elLat) elLat.textContent = lat.toFixed(6);
        if (elLng) elLng.textContent = lng.toFixed(6);
        if (elAcc) elAcc.textContent = Math.round(acc) + " m";

        postLocation(lat, lng, acc);
      }, function(err) {
        console.debug("geolocation error", err);
      });
    }

    var clockInButton = document.getElementById('clock-in');
    var clockOutButton = document.getElementById('clock-out');
    var clockInLast = document.getElementById('clock-in-last');
    var clockOutLast = document.getElementById('clock-out-last');
    var clockInElapsed = document.getElementById('clock-in-elapsed');
    var clockOutElapsed = document.getElementById('clock-out-elapsed');
    var clockEventForm = document.getElementById('clock-event-form');
    var clockEventEndpoint = clockEventForm ? clockEventForm.dataset.endpoint : null;
    var clockEventTypeInput = document.getElementById('clock-event-type');
    var clockEventTimestampInput = document.getElementById('clock-event-timestamp');
    var clockEventLatInput = document.getElementById('clock-event-lat');
    var clockEventLngInput = document.getElementById('clock-event-lng');
    var clockEventAccuracyInput = document.getElementById('clock-event-accuracy');
    var clockInStartedAt = null;
    var elapsedTicker = null;

    function formatDateTime(date) {
      return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function formatDuration(ms) {
      if (!isFinite(ms) || ms < 0) ms = 0;
      var totalSeconds = Math.floor(ms / 1000);
      var hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      var minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      var seconds = String(totalSeconds % 60).padStart(2, '0');
      return hours + ":" + minutes + ":" + seconds;
    }

    function stopElapsedTicker() {
      if (elapsedTicker) {
        clearInterval(elapsedTicker);
        elapsedTicker = null;
      }
    }

    function tickElapsed() {
      if (!clockInStartedAt || !clockInElapsed) return;
      clockInElapsed.textContent = formatDuration(Date.now() - clockInStartedAt.getTime());
    }

    function startElapsedTicker() {
      stopElapsedTicker();
      tickElapsed();
      elapsedTicker = setInterval(tickElapsed, 1000);
    }

    function sendClockEvent(eventType) {
      if (!clockEventEndpoint) return;
      var payload = {
        event_type: eventType,
        timestamp: new Date().toISOString()
      };
      if (lastKnownPosition) {
        payload.lat = lastKnownPosition.lat;
        payload.lng = lastKnownPosition.lng;
        if (typeof lastKnownPosition.accuracy === 'number') {
          payload.accuracy = lastKnownPosition.accuracy;
        }
      }
      if (clockEventTypeInput) clockEventTypeInput.value = payload.event_type;
      if (clockEventTimestampInput) clockEventTimestampInput.value = payload.timestamp;
      if (clockEventLatInput) clockEventLatInput.value = payload.lat == null ? "" : payload.lat;
      if (clockEventLngInput) clockEventLngInput.value = payload.lng == null ? "" : payload.lng;
      if (clockEventAccuracyInput) clockEventAccuracyInput.value = payload.accuracy == null ? "" : payload.accuracy;

      fetch(clockEventEndpoint, {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(function(err) {
        console.debug("clock event post failed", err);
      });
    }

    clockInButton && clockInButton.addEventListener('click', function() {
      var now = new Date();
      clockInStartedAt = now;
      if (clockInLast) {
        clockInLast.textContent = formatDateTime(now);
        clockInLast.setAttribute('datetime', now.toISOString());
      }
      if (clockInElapsed) {
        clockInElapsed.textContent = '00:00:00';
      }
      if (clockOutElapsed) {
        clockOutElapsed.textContent = '--';
      }
      startElapsedTicker();
      sendClockEvent('clock_in');
    });

    clockOutButton && clockOutButton.addEventListener('click', function() {
      var now = new Date();
      if (clockOutLast) {
        clockOutLast.textContent = formatDateTime(now);
        clockOutLast.setAttribute('datetime', now.toISOString());
      }
      if (clockInStartedAt) {
        var duration = now.getTime() - clockInStartedAt.getTime();
        var formatted = formatDuration(duration);
        if (clockOutElapsed) clockOutElapsed.textContent = formatted;
        if (clockInElapsed) clockInElapsed.textContent = formatted;
      } else if (clockOutElapsed) {
        clockOutElapsed.textContent = '00:00:00';
      }
      stopElapsedTicker();
      clockInStartedAt = null;
      sendClockEvent('clock_out');
    });
    
    // Student Location History Map
    const historyMapElement = document.getElementById("history-map");
    if (historyMapElement && typeof L !== "undefined") {
        const historyMap = L.map(historyMapElement).setView([39.8283, -98.5795], 4);
        
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "¬© OpenStreetMap contributors",
        }).addTo(historyMap);
        
        // Add student's location history
        const studentLocations = [];
        {% if student_locations %}
        {% for location in student_locations %}
        const date{{ loop.index }} = new Date("{{ location.created_at.isoformat() }}Z");
        studentLocations.push({
            lat: {{ location.lat }},
            lng: {{ location.lng }},
            city: {{ (location.city or 'Unknown')|tojson }},
            time: date{{ loop.index }}.toLocaleString('en-US', {
                timeZone: 'America/New_York',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            }) + ' EST',
            notes: {{ (location.notes or '')|tojson }}
        });
        {% endfor %}
        {% endif %}
        
        const historyMarkers = [];
        studentLocations.forEach((loc, index) => {
            const popupContent = `<strong>Your Location</strong><br>${loc.city}<br><small>${loc.time}</small>${loc.notes ? '<br><small>' + loc.notes + '</small>' : ''}`;
            
            const marker = L.marker([loc.lat, loc.lng])
                .addTo(historyMap)
                .bindPopup(popupContent);
            historyMarkers.push(marker);
        });
        
        if (historyMarkers.length > 0) {
            const group = new L.featureGroup(historyMarkers);
            historyMap.fitBounds(group.getBounds().pad(0.1));
        } else {
            // If no history, center on current location if available
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    historyMap.setView([pos.coords.latitude, pos.coords.longitude], 10);
                });
            }
        }
    }
    
    // Clear locations functionality
    document.getElementById('clear-locations-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all your location history? This cannot be undone.')) {
            fetch('/app/clear-locations', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Location history cleared successfully!');
                    location.reload();
                } else {
                    alert('Failed to clear locations: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error clearing locations:', err);
                alert('Failed to clear locations. Please try again.');
            });
        }
    });
    
    // Send heartbeat every 2 minutes to track active sessions
    setInterval(function() {
        fetch('/app/heartbeat', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        }).catch(err => console.debug('Heartbeat failed:', err));
    }, 120000); // 2 minutes
    </script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification-badge.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>
</html>
