<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Dashboard | Student Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body class="layout">
    <header class="page-header">
        <a class="brand" href="{{ url_for('main.landing_page') }}">Student Location Tracker</a>
        <nav class="page-nav">
            <a href="{{ url_for('main.professor_dashboard') }}" class="nav__item nav__item--active">Dashboard</a>
            <a href="/app/classes/" class="nav__item">My Classes</a>
            <a href="{{ url_for('main.database') }}" class="nav__item">Database</a>
            <a href="{{ url_for('auth.logout') }}" class="nav__item">Log Out</a>
        </nav>
    </header>
    <main class="dashboard">
        <section class="dashboard__panel">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                {% if professor.profile_picture %}
                    <img src="{{ professor.profile_picture }}" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--primary);">
                {% endif %}
                <div>
                    <h1 style="margin: 0;">Welcome, {{ professor.title or 'Professor' }} {{ full_name }}!</h1>
                    {% if professor.is_oauth_user %}
                        <span style="background: var(--accent); color: var(--text); padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">Google Account</span>
                    {% endif %}
                </div>
            </div>
            <p class="dashboard__subtitle">Monitor student locations and manage your classes from this dashboard.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                <div>
                    <strong>Employee ID:</strong> {{ professor.employee_id or 'Not set' }}<br>
                    <strong>Department:</strong> {{ professor.department or 'Not specified' }}<br>
                    <strong>Title:</strong> {{ professor.title or 'Not specified' }}
                </div>
                <div>
                    <strong>Email:</strong> {{ professor.email }}<br>
                    <strong>Member since:</strong> {{ professor.created_at.strftime('%B %Y') }}<br>
                    <strong>Account type:</strong> {{ 'OAuth' if professor.is_oauth_user else 'Traditional' }}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                <div class="card">
                    <h3>Your Classes</h3>
                    {% if classes %}
                        <ul style="list-style: none; padding: 0;">
                            {% for class in classes %}
                            <li style="margin: 0.5rem 0; padding: 0.5rem; background: var(--muted); border-radius: 8px;">
                                <strong>{{ class.course_code }}</strong>: {{ class.course_name }}<br>
                                <small>{{ class.semester }} {{ class.year }} | {{ class.room or 'Room TBD' }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No classes assigned yet.</p>
                    {% endif %}
                </div>

                <div class="card">
                    <h3>Recent Student Activity</h3>
                    {% if recent_locations_raw %}
                        <ul style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;">
                            {% for location in recent_locations_raw[:10] %}
                            <li style="margin: 0.5rem 0; padding: 0.5rem; background: var(--muted); border-radius: 8px; font-size: 0.9rem;">
                                <strong>{{ location.student.full_name }}</strong><br>
                                <small>{{ location.city or 'Unknown location' }} - {{ location.created_at|format_dt }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No recent student activity.</p>
                    {% endif %}
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--primary);">üó∫Ô∏è Student Location Map</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="toggle-inactive-btn" class="btn" style="background: var(--primary); color: white;">
                        üëÅÔ∏è Show Live Only
                    </button>
                    <button id="clear-all-locations-btn" class="btn" style="background: #ef4444; color: white;">
                        üóëÔ∏è Clear Real Student Locations
                    </button>
                </div>
            </div>
            <div id="location-map" class="dashboard__map" role="img" aria-label="Map showing recent student locations"></div>
            <p class="dashboard__message">Map shows recent student check-ins across campus.</p>
        </section>
    </main>
    <footer class="footer">
        <small>&copy; 2025 Student Tracker. Built with Flask.</small>
    </footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const mapElement = document.getElementById("location-map");
        
        if (!mapElement || typeof L === "undefined") {
            return;
        }

        const map = L.map(mapElement).setView([39.8283, -98.5795], 4);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);

        // Function to format time to EST
        function formatToEST(date) {
            const options = {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options) + ' EST';
        }
        
        // Function to get relative time
        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return "Just now";
            if (diffMins < 60) return diffMins + " minute" + (diffMins > 1 ? 's' : '') + " ago";
            if (diffHours < 24) return diffHours + " hour" + (diffHours > 1 ? 's' : '') + " ago";
            return diffDays + " day" + (diffDays > 1 ? 's' : '') + " ago";
        }

        const locations = [];
        
        // Add real student locations from server data
        const serverLocations = {{ recent_locations|tojson if recent_locations else '[]' }};
        
        serverLocations.forEach(function(location, index) {
            if (location.lat && location.lng) {
                const locationDate = new Date(location.created_at + 'Z');
                
                locations.push({
                    lat: location.lat,
                    lng: location.lng,
                    student: location.student.full_name,
                    city: location.city || 'Unknown',
                    time: formatToEST(locationDate),
                    relativeTime: getRelativeTime(locationDate),
                    isLive: location.is_live,
                    isFake: location.is_fake,
                    type: location.is_fake ? "fake" : "real"
                });
            }
        });
        
        // All locations now come from the database (both real and fake)

        let showInactiveLocations = true;
        const markers = [];
        
        function createMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers.length = 0;
            
            const filteredLocations = showInactiveLocations ? 
                locations : 
                locations.filter(loc => loc.isLive);
            
            filteredLocations.forEach(loc => {
                let popupContent = "<strong>" + loc.student + "</strong><br>" + loc.city;
                popupContent += "<br><small>" + loc.relativeTime + "</small><br><small>" + loc.time + "</small>";
                
                if (loc.isLive) {
                    popupContent += "<br><span style='color: #22c55e; font-weight: bold;'>üü¢ LIVE NOW</span>";
                } else {
                    popupContent += "<br><span style='color: #f59e0b; font-weight: bold;'>üü° LAST ACTIVE</span>";
                }
                
                // Use different marker colors for live vs inactive
                const marker = L.marker([loc.lat, loc.lng])
                    .addTo(map)
                    .bindPopup(popupContent);
                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Initial marker creation
        createMarkers();
        
        console.log("Map loaded with " + locations.length + " total locations");
        
        // Toggle inactive locations functionality
        document.getElementById('toggle-inactive-btn').addEventListener('click', function() {
            showInactiveLocations = !showInactiveLocations;
            this.textContent = showInactiveLocations ? 'üëÅÔ∏è Show Live Only' : 'üëÅÔ∏è Show All';
            this.style.background = showInactiveLocations ? 'var(--primary)' : '#22c55e';
            createMarkers();
        });
        
        // Clear real locations functionality (Professor only)
        document.getElementById('clear-all-locations-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear real student location data? This will keep demo locations but remove actual student check-ins.')) {
                fetch('/app/clear-all-locations', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Real student locations cleared successfully! Demo data preserved.');
                        location.reload();
                    } else {
                        alert('Failed to clear locations: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error clearing locations:', err);
                    alert('Failed to clear locations. Please try again.');
                });
            }
        });
    });
    </script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>
</html>